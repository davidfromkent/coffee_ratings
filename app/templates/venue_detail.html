{% extends "base.html" %}
{% import "cup_macros.html" as cups %}

{% block content %}

<!-- Venue name + location -->
<h2 class="text-2xl font-bold text-[#f7f2e9]">
    {{ venue.name }}
</h2>
<p class="text-[#e8dfd1] text-sm mb-4">
    {{ venue.location }}
</p>

{% if msg == "deleted" %}
<div class="mb-4 bg-[#6d4c41] text-[#f7f2e9] p-3 rounded-lg shadow text-sm">
    Review deleted.
</div>
{% elif msg == "denied" %}
<div class="mb-4 bg-red-700 text-white p-3 rounded-lg shadow text-sm">
    You cannot delete that review.
</div>
{% elif msg == "notfound" %}
<div class="mb-4 bg-red-700 text-white p-3 rounded-lg shadow text-sm">
    Review not found.
</div>
{% endif %}

<!-- Average scores box -->
<div class="bg-[#f7f2e9] rounded-xl p-4 shadow-md text-[#4b3621]">
    <h3 class="text-lg font-semibold mb-4">Average scores</h3>

    <div class="grid grid-cols-2 gap-x-6 gap-y-6">
        <div>
            <p class="text-sm text-[#6d5742] mb-1">Coffee</p>
            {{ cups.render_cups(venue.avg_coffee or 0) }}
        </div>

        <div>
            <p class="text-sm text-[#6d5742] mb-1">Value</p>
            {{ cups.render_cups(venue.avg_cost or 0) }}
        </div>

        <div>
            <p class="text-sm text-[#6d5742] mb-1">Service</p>
            {{ cups.render_cups(venue.avg_service or 0) }}
        </div>

        <div>
            <p class="text-sm text-[#6d5742] mb-1">Hygiene</p>
            {{ cups.render_cups(venue.avg_hygiene or 0) }}
        </div>

        <div>
            <p class="text-sm text-[#6d5742] mb-1">Ambience</p>
            {{ cups.render_cups(venue.avg_ambience or 0) }}
        </div>

        <div>
            <p class="text-sm text-[#6d5742] mb-1">Food</p>
            {{ cups.render_cups(venue.avg_food or 0) }}
        </div>
    </div>
</div>

<!-- Add review button -->
<div class="mt-6">
    <a href="/reviews/new?venue_id={{ venue.id }}"
       class="w-full block text-center bg-[#6d4c41] text-[#f7f2e9] py-3 rounded-lg font-semibold shadow hover:bg-[#5d4037]">
        Add Review
    </a>
</div>

<!-- Reviews header -->
<h3 class="text-lg font-semibold text-[#f7f2e9] mt-8 mb-3">
    Reviews ({{ venue.reviews|length }})
</h3>

{% if venue.reviews|length == 0 %}
<p class="text-[#e8dfd1] text-sm mb-4">No reviews yet.</p>
{% else %}

<div class="flex flex-col gap-4">
{% for r in venue.reviews %}
<div class="bg-[#f7f2e9] rounded-xl p-4 shadow text-[#4b3621]"
     data-review-id="{{ r.id }}"
     data-review-identity-pin="{{ r.identity_pin }}">

    <!-- Rating -->
    <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-2">
            {% set avg = r.total_score / r.category_count %}
            {{ cups.render_cups(avg) }}
        </div>
        <span class="text-sm font-semibold">
            {{ "%.1f"|format(avg) }}
        </span>
    </div>

    <!-- Category grid -->
    <div class="grid grid-cols-3 gap-x-4 gap-y-2 mt-3 text-sm text-[#6d5742]">
        <p>Coffee: {{ r.coffee }}</p>
        <p>Value: {{ r.cost }}</p>
        <p>Service: {{ r.service }}</p>
        <p>Hygiene: {{ r.hygiene }}</p>
        <p>Ambience: {{ r.ambience }}</p>
        <p>
            {% if r.food == 0 %}
                Food: N/A
            {% else %}
                Food: {{ r.food }}
            {% endif %}
        </p>
    </div>

    <!-- Notes -->
    {% if r.notes %}
    <p class="text-sm italic mt-2">{{ r.notes }}</p>
    {% endif %}

    <!-- Reviewer, date + actions -->
    {% set d = r.visit_date.split("-") %}
    <div class="mt-3 flex items-end justify-between gap-3">
        <p class="text-xs">
            {{ r.reviewer_name }}, {{ d[2] }}/{{ d[1] }}/{{ d[0] }}
        </p>

        <!-- Shown only if this review belongs to this device -->
        <div class="my-review-actions hidden flex gap-3 text-xs">
            <a href="/reviews/{{ r.id }}/edit" class="text-[#6d4c41] hover:underline">
                ‚úèÔ∏è Edit
            </a>

            <form method="post" action="/reviews/{{ r.id }}/delete" class="delete-review-form inline">
                <input type="hidden" name="identity_pin" class="identity-pin-field">
                <button type="submit" class="text-[#a63a2b] hover:underline">
                    üóëÔ∏è Delete
                </button>
            </form>
        </div>
    </div>

</div>
{% endfor %}
</div>

{% endif %}

{% endblock %}
