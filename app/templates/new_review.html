{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto space-y-6">

    <form action="{{ form_action if form_action else '/reviews/new' }}"
          method="post"
          class="space-y-6"
          id="reviewForm"
          onsubmit="return validateNameAndStore()">

        {% if existing_review_id %}
        <input type="hidden" name="existing_review_id" value="{{ existing_review_id }}">
        {% endif %}

        <!-- Reviewer name section (only shown when unlocked) -->
        <div id="name-section" class="mb-4 hidden">
            <label class="block text-[#e8dfd1] text-sm mb-1">Your name</label>
            <input type="text" id="reviewer_name" name="reviewer_name"
                   value="{{ form_data.reviewer_name if form_data and form_data.reviewer_name is not none else '' }}"
                   class="w-full p-3 rounded-lg bg-[#f7f2e9] text-[#4b3621] shadow outline-none"
                   placeholder="Forename Surname">

            <p id="name-error" class="text-red-300 text-xs mt-1 hidden">
                Please enter your full name (at least two words).
            </p>
        </div>

        <!-- Venue name + location -->
        <div class="space-y-4">
            <input type="text" name="venue_name" placeholder="Venue name" required
                value="{{ form_data.venue_name if form_data and form_data.venue_name is not none else '' }}"
                class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] shadow"/>

            <input type="text" name="location" placeholder="Location" required
                value="{{ form_data.location if form_data and form_data.location is not none else '' }}"
                class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] shadow"/>
        </div>

        <!-- LOCATION PICK (current location) -->
        <div class="bg-[#6d4c41] rounded-xl shadow p-4 space-y-2">
            <p class="text-[#f7f2e9] text-sm font-semibold">Branch location</p>

            <button type="button"
                    id="useLocationBtn"
                    class="w-full bg-[#4b3621] text-[#f7f2e9] py-2 rounded-lg shadow">
                Use my current location
            </button>

            <p id="locationStatus" class="text-[#e8dfd1] text-xs"></p>

            <input type="hidden" name="venue_lat" id="venue_lat"
                   value="{{ form_data.venue_lat if form_data and form_data.venue_lat is not none else '' }}">
            <input type="hidden" name="venue_lng" id="venue_lng"
                   value="{{ form_data.venue_lng if form_data and form_data.venue_lng is not none else '' }}">
        </div>

        <!-- SCORES -->
        <div class="bg-[#6d4c41] rounded-xl shadow p-4 space-y-3">
            <h3 class="text-[#f7f2e9] text-lg font-semibold mb-1">Scores</h3>
            <div class="grid grid-cols-2 gap-3">
                {% for category in ["coffee","cost","service","hygiene","ambience"] %}
                <div>
                    <label class="block text-xs text-[#f7f2e9] mb-1">
                        {% if category == "cost" %}Value{% else %}{{ category.capitalize() }}{% endif %}
                    </label>
                    <select name="{{ category }}" required
                        class="w-full rounded-lg p-2 bg-[#4b3621] text-[#f7f2e9]">
                        <option value="" disabled {% if not form_data or form_data[category] is not defined or form_data[category] in [None, ''] %}selected{% endif %} hidden>Select</option>
                        {% for s in [5,4,3,2,1] %}
                        <option value="{{ s }}" {% if form_data and form_data[category] is defined and form_data[category] is not none and (form_data[category]|int) == s %}selected{% endif %}>{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}

                <div>
                    <label class="block text-xs text-[#f7f2e9] mb-1">Food (or N/A)</label>
                    <select name="food" required
                        class="w-full rounded-lg p-2 bg-[#4b3621] text-[#f7f2e9]">
                        <option value="" disabled {% if not form_data or form_data.food is not defined or form_data.food in [None, ''] %}selected{% endif %} hidden>Select</option>
                        <option value="5" {% if form_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 5 %}selected{% endif %}>5</option>
                        <option value="4" {% if form_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 4 %}selected{% endif %}>4</option>
                        <option value="3" {% if form_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 3 %}selected{% endif %}>3</option>
                        <option value="2" {% if formfform_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 2 %}selected{% endif %}>2</option>
                        <option value="1" {% if form_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 1 %}selected{% endif %}>1</option>
                        <option value="0" {% if form_data and form_data.food is defined and form_data.food is not none and (form_data.food|int) == 0 %}selected{% endif %}>N/A</option>
                    </select>
                </div>
            </div>
        </div>

        <textarea name="notes" placeholder="Notes (optional)"
            class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] h-16 shadow">{{ form_data.notes if form_data and form_data.notes is not none else '' }}</textarea>

        <!-- Visit date -->
        <label class="block text-xs text-[#f7f2e9] mb-0">Visit date</label>
        <div class="relative">
            <input type="date" name="visit_date"
                   value="{{ form_data.visit_date if form_data and form_data.visit_date is not none else '' }}"
                   class="w-full rounded-lg p-3 pt-2 bg-[#6d4c41] text-[#f7f2e9] shadow pr-10"
                   max=""
                   required>
            <span class="absolute right-3 top-3 text-[#e8dfd1] pointer-events-none">ðŸ“…</span>
        </div>

        <!-- Hidden identity -->
        <input type="hidden" id="identity_pin" name="identity_pin" value="{{ form_data.identity_pin if form_data and form_data.identity_pin is not none else '' }}">

        <a id="changeNameBtn"
           class="hidden text-[#e8dfd1] text-xs underline hover:text-white mb-2 cursor-pointer">
            Change name
        </a>

        <!-- PIN unlock -->
        <div id="pin-section" class="hidden mt-3">
            <p class="text-[#e8dfd1] text-xs mb-1">
                Your PIN: <span id="pin_display" class="font-semibold"></span>
            </p>
            <input type="number" id="pin_input"
                class="w-full p-2 rounded bg-[#f7f2e9] text-[#4b3621] text-sm outline-none"
                placeholder="PIN to unlock">
            <p id="pin-error" class="text-red-300 text-xs mt-1 hidden">
                Incorrect PIN
            </p>
            <button type="button" id="unlockBtn"
                class="mt-2 text-xs bg-[#6d4c41] text-[#f7f2e9] py-1 px-3 rounded shadow">
                Unlock
            </button>
        </div>

        <button type="submit"
            class="w-full bg-[#6d4c41] text-[#f7f2e9] py-3 rounded-xl font-semibold hover:bg-[#5d4037] shadow">
            {% if is_edit %}Save Changes{% else %}Save Review{% endif %}
        </button>

    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const nameSection = document.getElementById("name-section");
    const nameField = document.getElementById("reviewer_name");
    const pinField = document.getElementById("identity_pin");

    const changeNameBtn = document.getElementById("changeNameBtn");
    const pinSection = document.getElementById("pin-section");
    const pinDisplay = document.getElementById("pin_display");
    const pinInput = document.getElementById("pin_input");
    const pinError = document.getElementById("pin-error");
    const unlockBtn = document.getElementById("unlockBtn");

    const venueLat = document.getElementById("venue_lat");
    const venueLng = document.getElementById("venue_lng");
    const useLocationBtn = document.getElementById("useLocationBtn");
    const locationStatus = document.getElementById("locationStatus");

    const visitDateInput = document.querySelector('input[name="visit_date"]');
    if (visitDateInput) {
        const today = new Date().toISOString().split("T")[0];
        visitDateInput.max = today;

        if (!visitDateInput.value) {
            visitDateInput.value = today;
        }
    }

    const storedName = localStorage.getItem("reviewer_name");
    let storedPIN = localStorage.getItem("identity_pin");

    if (!storedPIN) {
        storedPIN = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem("identity_pin", storedPIN);
    }

    if (pinField) pinField.value = storedPIN;
    if (pinDisplay) pinDisplay.textContent = storedPIN;

    if (storedName && nameField && !nameField.value) {
        nameField.value = storedName;
    }

    if (storedName) {
        nameSection.style.display = "none";
        nameField.removeAttribute("required");
        changeNameBtn.classList.remove("hidden");
    } else {
        nameSection.classList.remove("hidden");
        nameField.setAttribute("required", "required");
        changeNameBtn.classList.add("hidden");
    }

    changeNameBtn.addEventListener("click", function () {
        pinSection.classList.remove("hidden");
        pinError.classList.add("hidden");
        pinInput.value = "";
        pinInput.focus();
    });

    unlockBtn.addEventListener("click", function () {
        const entered = (pinInput.value || "").trim();
        if (entered === storedPIN) {
            nameSection.style.display = "";
            nameSection.classList.remove("hidden");
            nameField.setAttribute("required", "required");
            pinSection.classList.add("hidden");
            pinInput.value = "";
            nameField.focus();
        } else {
            pinError.classList.remove("hidden");
        }
    });

    function showLocationStatus(msg) {
        if (locationStatus) locationStatus.textContent = msg;
    }

    // If already filled (edit or previous attempt)
    if (venueLat && venueLng && venueLat.value && venueLng.value) {
        showLocationStatus("Location saved for this review.");
    }

    if (useLocationBtn) {
        useLocationBtn.addEventListener("click", function () {
            showLocationStatus("Getting your location...");

            if (!navigator.geolocation) {
                showLocationStatus("Location not supported on this device.");
                return;
            }

            navigator.geolocation.getCurrentPosition(
                function (pos) {
                    const lat = pos.coords.latitude.toString();
                    const lng = pos.coords.longitude.toString();
                    venueLat.value = lat;
                    venueLng.value = lng;
                    showLocationStatus("Location saved for this review.");
                },
                function () {
                    showLocationStatus("Could not get location. Check permissions.");
                },
                { enableHighAccuracy: false, timeout: 8000, maximumAge: 300000 }
            );
        });
    }
});

function validateNameAndStore() {
    const nameSection = document.getElementById("name-section");
    const nameField = document.getElementById("reviewer_name");

    if (nameSection && nameSection.style.display === "none") {
        return true;
    }

    const name = (nameField.value || "").trim();
    if (!name) {
        alert("Please enter your name");
        return false;
    }

    const parts = name.split(/\s+/);
    if (parts.length < 2) {
        alert("Please enter your full name (at least two words).");
        return false;
    }

    localStorage.setItem("reviewer_name", name);
    return true;
}
</script>

{% endblock %}
