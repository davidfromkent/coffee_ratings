{% extends "base.html" %}
{% block content %}

<div class="max-w-md mx-auto space-y-6">

    <form action="/reviews/new" method="post" class="space-y-6" id="reviewForm" onsubmit="return validateNameAndStore()">

        <!-- Reviewer name section (only shown when unlocked) -->
        <div id="name-section" class="mb-4 hidden">
            <label class="block text-[#e8dfd1] text-sm mb-1">Your name</label>
            <input type="text" id="reviewer_name" name="reviewer_name"
                   class="w-full p-3 rounded-lg bg-[#f7f2e9] text-[#4b3621] shadow outline-none"
                   placeholder="Forename Surname">

            <p id="name-error" class="text-red-300 text-xs mt-1 hidden">
                Please enter your full name (at least two words).
            </p>
        </div>

        <!-- Venue name + location -->
        <div class="space-y-4">
            <input type="text" name="venue_name" placeholder="Venue name" required
                class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] shadow"/>

            <input type="text" name="location" placeholder="Location" required
                class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] shadow"/>
        </div>

        <!-- SCORES -->
        <div class="bg-[#6d4c41] rounded-xl shadow p-4 space-y-3">
            <h3 class="text-[#f7f2e9] text-lg font-semibold mb-1">Scores</h3>
            <div class="grid grid-cols-2 gap-3">
                {% for category in ["coffee","cost","service","hygiene","ambience"] %}
                <div>
                    <label class="block text-xs text-[#f7f2e9] mb-1">
                        {% if category == "cost" %}Value{% else %}{{ category.capitalize() }}{% endif %}
                    </label>
                    <select name="{{ category }}" required
                        class="w-full rounded-lg p-2 bg-[#4b3621] text-[#f7f2e9]">
                        <option value="" disabled selected hidden>Select</option>
                        {% for s in [5,4,3,2,1] %}
                        <option value="{{ s }}">{{ s }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endfor %}
                <div>
                    <label class="block text-xs text-[#f7f2e9] mb-1">Food (or N/A)</label>
                    <select name="food" required
                        class="w-full rounded-lg p-2 bg-[#4b3621] text-[#f7f2e9]">
                        <option value="" disabled selected hidden>Select</option>
                        <option value="5">5</option><option value="4">4</option>
                        <option value="3">3</option><option value="2">2</option>
                        <option value="1">1</option><option value="0">N/A</option>
                    </select>
                </div>
            </div>
        </div>

        <textarea name="notes" placeholder="Notes (optional)"
            class="w-full rounded-lg p-3 bg-[#6d4c41] text-[#f7f2e9] placeholder-[#d8cfc4] h-16 shadow"></textarea>

        <!-- Visit date -->
        <label class="block text-xs text-[#f7f2e9] mb-0">Visit date</label>
        <div class="relative">
            <input type="date" name="visit_date"
                   class="w-full rounded-lg p-3 pt-2 bg-[#6d4c41] text-[#f7f2e9] shadow pr-10"
				   max=""
                   required>
            <span class="absolute right-3 top-3 text-[#e8dfd1] pointer-events-none">ðŸ“…</span>
        </div>

        <!-- Hidden identity -->
        <input type="hidden" id="identity_pin" name="identity_pin">

        <a id="changeNameBtn"
           class="hidden text-[#e8dfd1] text-xs underline hover:text-white mb-2 cursor-pointer">
            Change name
        </a>

        <!-- PIN unlock -->
        <div id="pin-section" class="hidden mt-3">
            <p class="text-[#e8dfd1] text-xs mb-1">
                Your PIN: <span id="pin_display" class="font-semibold"></span>
            </p>
            <input type="number" id="pin_input"
                class="w-full p-2 rounded bg-[#f7f2e9] text-[#4b3621] text-sm outline-none"
                placeholder="PIN to unlock">
            <p id="pin-error" class="text-red-300 text-xs mt-1 hidden">
                Incorrect PIN
            </p>
            <button type="button" id="unlockBtn"
                class="mt-2 text-xs bg-[#6d4c41] text-[#f7f2e9] py-1 px-3 rounded shadow">
                Unlock
            </button>
        </div>

        <button type="submit"
            class="w-full bg-[#6d4c41] text-[#f7f2e9] py-3 rounded-xl font-semibold hover:bg-[#5d4037] shadow">
            Save Review
        </button>

    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const nameSection = document.getElementById("name-section");
    const nameField = document.getElementById("reviewer_name");
    const pinField = document.getElementById("identity_pin");

    const changeNameBtn = document.getElementById("changeNameBtn");
    const pinSection = document.getElementById("pin-section");
    const pinDisplay = document.getElementById("pin_display");
    const pinInput = document.getElementById("pin_input");
    const pinError = document.getElementById("pin-error");
    const unlockBtn = document.getElementById("unlockBtn");

    const storedName = localStorage.getItem("reviewer_name");
	document.querySelector('input[name="visit_date"]').max = new Date().toISOString().split("T")[0];
    let storedPIN = localStorage.getItem("identity_pin");

    if (!storedPIN) {
        storedPIN = Math.floor(100000 + Math.random() * 900000).toString();
        localStorage.setItem("identity_pin", storedPIN);
    }
    pinField.value = storedPIN;
    pinDisplay.textContent = storedPIN;

    if (storedName) {
        nameField.value = storedName;
        nameSection.style.display = "none";
        nameField.removeAttribute("required");
        changeNameBtn.classList.remove("hidden");
    } else {
        nameSection.classList.remove("hidden");
        nameField.setAttribute("required", "required");
        changeNameBtn.classList.add("hidden");
    }

    changeNameBtn.addEventListener("click", function () {
        pinSection.classList.remove("hidden");
        pinError.classList.add("hidden");
        pinInput.value = "";
        pinInput.focus();
    });

    unlockBtn.addEventListener("click", function () {
        const entered = (pinInput.value || "").trim();
        if (entered === storedPIN) {
            nameSection.style.display = "";
            nameSection.classList.remove("hidden");
            nameField.setAttribute("required", "required");
            pinSection.classList.add("hidden");
            pinInput.value = "";
            nameField.focus();
        } else {
            pinError.classList.remove("hidden");
        }
    });
});

function validateNameAndStore() {
    const nameSection = document.getElementById("name-section");
    const nameField = document.getElementById("reviewer_name");

    if (nameSection.style.display === "none") {
        return true;
    }

    const name = (nameField.value || "").trim();
    if (!name) {
        alert("Please enter your name");
        return false;
    }

    const parts = name.split(/\s+/);
    if (parts.length < 2) {
        alert("Please enter your full name (at least two words).");
        return false;
    }

    localStorage.setItem("reviewer_name", name);
    return true;
}
</script>

{% endblock %}
